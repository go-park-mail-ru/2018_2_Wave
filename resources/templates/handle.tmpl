{{$CORS := .Config.CORS}}
{{range .Handlers}}

func Handler{{.FunctionName}} ( ctx *fasthttp.RequestCtx, sv *server.Server) {
    
    println("request for {{.FunctionName}}")

    ctx.Response.Header.Set("Access-Control-Allow-Origin",      "{{$CORS.Origin}}")
    ctx.Response.Header.Set("Access-Control-Allow-Credentials", "{{$CORS.Credentials}}")
	ctx.Response.Header.Set("Access-Control-Allow-Methods",     "{{$CORS.Methods}}")
	ctx.Response.Header.Set("Access-Control-Allow-Headers",     "{{$CORS.Headers}}")

    {{if eq .Auth "true"}}   

        cookie := misc.GetSessionCookie(ctx)
        if ok, err := sv.DB.IsLoggedIn(cookie); !ok || err != nil {
            ctx.SetStatusCode(fasthttp.StatusUnauthorized)
            return
        }

    {{else if eq .Auth "false"}}

        cookie := misc.GetSessionCookie(ctx)
        if ok, err := sv.DB.IsLoggedIn(cookie); ok || err != nil {
            ctx.SetStatusCode(fasthttp.StatusForbidden)
            return
        }

    {{end}}

    {{if eq .Data "form"}}
        
        target := {{.Target}}{}

        if form, err := ctx.MultipartForm(); err != nil {
            ctx.SetStatusCode(fasthttp.StatusBadRequest)
            return
        } else if err := target.UnmarshalForm(form); err != nil {
            ctx.SetStatusCode(fasthttp.StatusBadRequest)
            return
        }

        {{if eq .Validation "true"}}
            if !target.Validate() {
                ctx.SetStatusCode(fasthttp.StatusBadRequest)
                return
            }
        {{end}}

        {{.FunctionName}}( ctx, sv, target )

    {{else if eq .Data "json"}}

        target := {{.Target}}{}

        if err := target.UnmarshalJSON( ctx.Request.Body() ); err != nil {
            ctx.SetStatusCode(fasthttp.StatusBadRequest)
            return
        }

        {{if eq .Validation "true"}}
            if !target.Validate() {
                ctx.SetStatusCode(fasthttp.StatusBadRequest)
                return
            }
        {{end}}

        {{.FunctionName}}( ctx, sv, target )

    {{else if eq .Data "uri"}}

        target := {{.Target}}{}

        if err := target.UnmarshalURI( ctx ); err != nil {
            ctx.SetStatusCode(fasthttp.StatusBadRequest)
            return
        }

        {{if eq .Validation "true"}}
            if !target.Validate() {
                ctx.SetStatusCode(fasthttp.StatusBadRequest)
                return
            }
        {{end}}

        {{.FunctionName}}( ctx, sv, target)

    {{else}}

        {{.FunctionName}}( ctx, sv )

    {{end}}
}

{{end}}